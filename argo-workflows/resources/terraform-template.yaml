apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: terraform
  namespace: workflow-playground
spec:
  onExit: notify-github
  imagePullSecrets:
    - name: docker-registry-config
  arguments:
    parameters:
      - name: repo_url
        value: ""
      - name: repo_owner
        value: ""
      - name: repo_name
        value: ""
      - name: branch
        value: "main"
      - name: terraform_version
        value: "1.7.0"
      - name: terraform_dir
        value: "."
      - name: terraform_operation
        value: "plan"
      - name: terraform_backend_config
        value: ""
      - name: terraform_vars
        value: ""
      - name: auto_approve
        value: "false"
      - name: github_username
        value: ""
      - name: pr_number
        value: ""
      - name: commit_sha
        value: ""
      - name: head_repo_owner
        value: ""
      - name: head_repo_name
        value: ""
      - name: aws_region
        value: "us-east-1"
      - name: aws_role_arn
        value: ""
      - name: aws_credentials_secret
        value: "secret-to-be-created"
  entrypoint: main
  activeDeadlineSeconds: 3600
  ttlStrategy:
    secondsAfterCompletion: 7200
    secondsAfterSuccess: 3600
    secondsAfterFailure: 14400
  volumeClaimTemplates:
    - metadata:
        name: workspace
        generateName: terraform-workspace-
      spec:
        accessModes:
          - ReadWriteOnce
        resources:
          requests:
            storage: 5Gi
  volumes:
    - name: github-token
      secret:
        secretName: github-access
  templates:
    - name: main
      dag:
        tasks:
          - name: verify-token
            template: verify-github-token
          - name: clone
            template: git-clone
            dependencies:
              - verify-token
            arguments:
              parameters:
                - name: repo_url
                  value: "{{workflow.parameters.repo_url}}"
                - name: branch
                  value: "{{workflow.parameters.branch}}"
          - name: configure-aws
            template: configure-aws
            dependencies:
              - clone
            arguments:
              parameters:
                - name: aws_role_arn
                  value: "{{workflow.parameters.aws_role_arn}}"
                - name: aws_region
                  value: "{{workflow.parameters.aws_region}}"
                - name: session_name
                  value: "{{workflow.parameters.commit_sha}}"
          - name: terraform-init
            template: terraform-init
            dependencies:
              - configure-aws
            arguments:
              parameters:
                - name: terraform_version
                  value: "{{workflow.parameters.terraform_version}}"
                - name: terraform_dir
                  value: "{{workflow.parameters.terraform_dir}}"
                - name: terraform_backend_config
                  value: "{{workflow.parameters.terraform_backend_config}}"
          - name: terraform-validate
            template: terraform-validate
            dependencies:
              - terraform-init
            arguments:
              parameters:
                - name: terraform_version
                  value: "{{workflow.parameters.terraform_version}}"
                - name: terraform_dir
                  value: "{{workflow.parameters.terraform_dir}}"
          - name: terraform-fmt-check
            template: terraform-fmt-check
            dependencies:
              - terraform-init
            arguments:
              parameters:
                - name: terraform_version
                  value: "{{workflow.parameters.terraform_version}}"
                - name: terraform_dir
                  value: "{{workflow.parameters.terraform_dir}}"
          - name: terraform-operation
            template: terraform-execute
            dependencies:
              - terraform-validate
              - terraform-fmt-check
            arguments:
              parameters:
                - name: terraform_version
                  value: "{{workflow.parameters.terraform_version}}"
                - name: terraform_dir
                  value: "{{workflow.parameters.terraform_dir}}"
                - name: terraform_operation
                  value: "{{workflow.parameters.terraform_operation}}"
                - name: terraform_vars
                  value: "{{workflow.parameters.terraform_vars}}"
                - name: auto_approve
                  value: "{{workflow.parameters.auto_approve}}"
    - name: verify-github-token
      container:
        image: curlimages/curl:8.4.0
        command:
          - /bin/sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== Verifying GitHub Token ===="

            if [ ! -f /github-token/token ]; then
              echo "ERROR: GitHub token file not found!"
              exit 1
            fi

            TOKEN=$(cat /github-token/token)
            echo "Token length: ${#TOKEN} characters"

            if [ ${#TOKEN} -lt 30 ]; then
              echo "ERROR: GitHub token seems too short."
              exit 1
            fi

            RESPONSE=$(curl -s -o /tmp/response.json -w "%{http_code}" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/user)

            if [ "$RESPONSE" != "200" ]; then
              echo "ERROR: GitHub API returned status $RESPONSE"
              cat /tmp/response.json || true
              exit 1
            fi

            echo "GitHub token verification completed ✅"
        volumeMounts:
          - name: github-token
            mountPath: /github-token
            readOnly: true
        resources:
          requests:
            memory: 32Mi
            cpu: 50m
          limits:
            memory: 64Mi
            cpu: 100m
    - name: git-clone
      inputs:
        parameters:
          - name: repo_url
          - name: branch
      container:
        image: alpine/git:v2.52.0
        workingDir: /workspace
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== Cloning Repository ===="

            TOKEN=$(cat /github-token/token)
            git config --global credential.helper store
            printf 'https://x-access-token:%s@github.com\n' "$TOKEN" > /root/.git-credentials
            chmod 600 /root/.git-credentials

            git clone \
              --depth 1 \
              --branch "{{inputs.parameters.branch}}" \
              --single-branch \
              "{{inputs.parameters.repo_url}}" \
              .

            echo "Repository cloned successfully"
            echo "Git commit: $(git rev-parse HEAD)"
            echo "Files in workspace:"
            ls -la

            chmod -R 755 .
        volumeMounts:
          - name: workspace
            mountPath: /workspace
          - name: github-token
            mountPath: /github-token
            readOnly: true
        resources:
          requests:
            memory: 64Mi
            cpu: 100m
          limits:
            memory: 128Mi
            cpu: 200m
    - name: configure-aws
      inputs:
        parameters:
          - name: aws_role_arn
          - name: aws_region
          - name: session_name
      container:
        image: amazon/aws-cli:2.15.30
        workingDir: /workspace
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== AWS Configuration Debug ===="
            ROLE_ARN="{{inputs.parameters.aws_role_arn}}"
            REGION="{{inputs.parameters.aws_region}}"
            SESSION_NAME="{{inputs.parameters.session_name}}"

            echo "Role ARN: '${ROLE_ARN}'"
            echo "Region: '${REGION}'"
            echo "Session Name: '${SESSION_NAME}'"

            echo ""
            echo "==== Environment Variables ===="
            echo "AWS_ACCESS_KEY_ID is set: $([ -n "${AWS_ACCESS_KEY_ID:-}" ] && echo 'YES (length: '${#AWS_ACCESS_KEY_ID}')' || echo 'NO')"
            echo "AWS_SECRET_ACCESS_KEY is set: $([ -n "${AWS_SECRET_ACCESS_KEY:-}" ] && echo 'YES (length: '${#AWS_SECRET_ACCESS_KEY}')' || echo 'NO')"
            echo "AWS_SESSION_TOKEN is set: $([ -n "${AWS_SESSION_TOKEN:-}" ] && echo 'YES' || echo 'NO')"
            echo "AWS_REGION env: '${AWS_REGION:-<not set>}'"

            echo ""
            echo "==== All AWS_* Environment Variables ===="
            env | grep -E '^AWS_' || echo "No AWS_* variables found"

            echo ""
            echo "==== Secret Mount Verification ===="
            echo "Secret name from parameter: {{workflow.parameters.aws_credentials_secret}}"

            mkdir -p /workspace/.aws
            touch /workspace/.aws/credentials /workspace/.aws/config
            chmod 600 /workspace/.aws/credentials /workspace/.aws/config

            REGION_VALUE=${REGION:-${AWS_REGION:-us-east-1}}
            echo "Final region value: $REGION_VALUE"

            if [ -z "$ROLE_ARN" ]; then
              echo ""
              echo "==== Using Static Credentials Path ===="
              if [ -z "${AWS_ACCESS_KEY_ID:-}" ] || [ -z "${AWS_SECRET_ACCESS_KEY:-}" ]; then
                echo "ERROR: No AWS role ARN provided and static credentials were not supplied."
                echo "AWS_ACCESS_KEY_ID present: $([ -n "${AWS_ACCESS_KEY_ID:-}" ] && echo 'yes' || echo 'no')"
                echo "AWS_SECRET_ACCESS_KEY present: $([ -n "${AWS_SECRET_ACCESS_KEY:-}" ] && echo 'yes' || echo 'no')"
                exit 1
              fi

              {
                echo "[default]"
                echo "aws_access_key_id=${AWS_ACCESS_KEY_ID}"
                echo "aws_secret_access_key=${AWS_SECRET_ACCESS_KEY}"
                if [ -n "${AWS_SESSION_TOKEN:-}" ]; then
                  echo "aws_session_token=${AWS_SESSION_TOKEN}"
                fi
              } > /workspace/.aws/credentials

              {
                echo "[default]"
                echo "region=$REGION_VALUE"
                echo "output=json"
              } > /workspace/.aws/config

              echo "✅ Wrote static AWS credentials from mounted secret."
              echo "Access Key ID starts with: ${AWS_ACCESS_KEY_ID:0:10}..."
              exit 0
            fi

            echo ""
            echo "==== Using Role Assumption Path ===="
            SESSION_VALUE=${SESSION_NAME:-terraform-session}
            SESSION_VALUE=${SESSION_VALUE:0:64}

            echo "Assuming role $ROLE_ARN with session name $SESSION_VALUE in $REGION_VALUE"

            STS_OUTPUT=$(aws sts assume-role --role-arn "$ROLE_ARN" --role-session-name "$SESSION_VALUE" --duration-seconds 3600 --region "$REGION_VALUE" --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]' --output text)

            if [ -z "$STS_OUTPUT" ]; then
              echo "Failed to assume role $ROLE_ARN"
              exit 1
            fi

            IFS=$'\t' read -r ACCESS_KEY SECRET_KEY SESSION_TOKEN <<<"$STS_OUTPUT"

            if [ -z "$ACCESS_KEY" ] || [ "$ACCESS_KEY" = "None" ]; then
              echo "Failed to assume role $ROLE_ARN"
              exit 1
            fi

            {
              echo "[default]"
              echo "aws_access_key_id=$ACCESS_KEY"
              echo "aws_secret_access_key=$SECRET_KEY"
              echo "aws_session_token=$SESSION_TOKEN"
            } > /workspace/.aws/credentials

            {
              echo "[default]"
              echo "region=$REGION_VALUE"
              echo "output=json"
            } > /workspace/.aws/config

            echo "Wrote temporary credentials for role $ROLE_ARN"
        envFrom:
          - secretRef:
              name: "{{workflow.parameters.aws_credentials_secret}}"
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        resources:
          requests:
            memory: 64Mi
            cpu: 50m
          limits:
            memory: 128Mi
            cpu: 100m
    - name: terraform-init
      inputs:
        parameters:
          - name: terraform_version
          - name: terraform_dir
          - name: terraform_backend_config
      container:
        image: hashicorp/terraform:{{inputs.parameters.terraform_version}}
        workingDir: /workspace/{{inputs.parameters.terraform_dir}}
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== Terraform Init ===="

            terraform version

            if [ -n "{{inputs.parameters.terraform_backend_config}}" ]; then
              echo "{{inputs.parameters.terraform_backend_config}}" > /tmp/backend-config.txt
              terraform init -input=false $(awk '{if (NF) print "-backend-config=" $0}' /tmp/backend-config.txt | tr '\n' ' ')
            else
              terraform init -input=false
            fi

            echo "Terraform initialized successfully ✅"
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        envFrom:
          - secretRef:
              name: "{{workflow.parameters.aws_credentials_secret}}"
        resources:
          requests:
            memory: 256Mi
            cpu: 150m
          limits:
            memory: 512Mi
            cpu: 750m
        env:
          - name: AWS_PROFILE
            value: default
          - name: AWS_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_DEFAULT_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_SHARED_CREDENTIALS_FILE
            value: /workspace/.aws/credentials
          - name: AWS_CONFIG_FILE
            value: /workspace/.aws/config
    - name: terraform-validate
      inputs:
        parameters:
          - name: terraform_version
          - name: terraform_dir
      container:
        image: hashicorp/terraform:{{inputs.parameters.terraform_version}}
        workingDir: /workspace/{{inputs.parameters.terraform_dir}}
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== Terraform Validate ===="

            terraform validate

            echo "Terraform validation successful ✅"
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        envFrom:
          - secretRef:
              name: "{{workflow.parameters.aws_credentials_secret}}"
        resources:
          requests:
            memory: 256Mi
            cpu: 150m
          limits:
            memory: 768Mi
            cpu: 400m
        env:
          - name: AWS_PROFILE
            value: default
          - name: AWS_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_DEFAULT_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_SHARED_CREDENTIALS_FILE
            value: /workspace/.aws/credentials
          - name: AWS_CONFIG_FILE
            value: /workspace/.aws/config
    - name: terraform-fmt-check
      inputs:
        parameters:
          - name: terraform_version
          - name: terraform_dir
      container:
        image: hashicorp/terraform:{{inputs.parameters.terraform_version}}
        workingDir: /workspace/{{inputs.parameters.terraform_dir}}
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== Terraform Format Check ===="

            if ! terraform fmt -check -recursive -diff; then
              echo "WARNING: Terraform files are not properly formatted"
              echo "Run 'terraform fmt -recursive' to fix formatting"
            else
              echo "Terraform format check passed ✅"
            fi
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        envFrom:
          - secretRef:
              name: "{{workflow.parameters.aws_credentials_secret}}"
        resources:
          requests:
            memory: 128Mi
            cpu: 100m
          limits:
            memory: 256Mi
            cpu: 200m
        env:
          - name: AWS_PROFILE
            value: default
          - name: AWS_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_DEFAULT_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_SHARED_CREDENTIALS_FILE
            value: /workspace/.aws/credentials
          - name: AWS_CONFIG_FILE
            value: /workspace/.aws/config
    - name: terraform-execute
      inputs:
        parameters:
          - name: terraform_version
          - name: terraform_dir
          - name: terraform_operation
          - name: terraform_vars
          - name: auto_approve
      container:
        image: hashicorp/terraform:{{inputs.parameters.terraform_version}}
        workingDir: /workspace/{{inputs.parameters.terraform_dir}}
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            echo "==== Terraform {{inputs.parameters.terraform_operation}} ===="

            OPERATION="{{inputs.parameters.terraform_operation}}"

            VAR_ARGS=""
            if [ -n "{{inputs.parameters.terraform_vars}}" ]; then
              echo "Terraform working directory: $(pwd)"
              echo "Workspace contents:" && ls -al
              if [ -d "envs" ]; then
                echo "envs directory tree (max depth 3):"
                find envs -maxdepth 3 -type f -print
              else
                echo "envs directory not present"
              fi
              printf '%s\n' "{{inputs.parameters.terraform_vars}}" > /tmp/terraform-vars.txt
              while IFS= read -r line; do
                [ -z "$line" ] && continue
                case "$line" in
                  -var-file=*)
                    VAR_FILE=${line#-var-file=}
                    if [ -d "$VAR_FILE" ]; then
                      echo "Detected directory for var file: $VAR_FILE"
                    elif [ -f "$VAR_FILE" ]; then
                      echo "Var file located: $VAR_FILE"
                    else
                      echo "Var file missing: $VAR_FILE"
                      echo "Listing current and envs directories for debugging:" && ls -al && ls -al envs || true
                    fi
                    VAR_ARGS="$VAR_ARGS $line"
                    ;;
                  -var=*|-var|-var-file)
                    VAR_ARGS="$VAR_ARGS $line"
                    ;;
                  -*)
                    VAR_ARGS="$VAR_ARGS $line"
                    ;;
                  *)
                    VAR_ARGS="$VAR_ARGS -var=$line"
                    ;;
                esac
              done < /tmp/terraform-vars.txt
            fi

            case "$OPERATION" in
              plan)
                terraform plan -input=false $VAR_ARGS -out=/tmp/tfplan
                echo "Terraform plan saved to /tmp/tfplan"
                echo "Terraform plan completed ✅"
                ;;
              apply)
                AUTO_APPROVE="{{inputs.parameters.auto_approve}}"
                if [ "$AUTO_APPROVE" = "true" ]; then
                  terraform apply -input=false -auto-approve $VAR_ARGS
                else
                  echo "ERROR: Auto-approve is false. Apply operation requires auto-approve=true"
                  echo "For safety, manual approval is not supported in automated workflows"
                  exit 1
                fi
                echo "Terraform apply completed ✅"
                ;;
              destroy)
                AUTO_APPROVE="{{inputs.parameters.auto_approve}}"
                if [ "$AUTO_APPROVE" = "true" ]; then
                  terraform destroy -input=false -auto-approve $VAR_ARGS
                else
                  echo "ERROR: Auto-approve is false. Destroy operation requires auto-approve=true"
                  exit 1
                fi
                echo "Terraform destroy completed ✅"
                ;;
              output)
                terraform output -json
                echo "Terraform output retrieved ✅"
                ;;
              *)
                echo "ERROR: Unknown terraform operation: $OPERATION"
                echo "Supported operations: plan, apply, destroy, output"
                exit 1
                ;;
            esac
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        envFrom:
          - secretRef:
              name: "{{workflow.parameters.aws_credentials_secret}}"
        resources:
          requests:
            memory: 256Mi
            cpu: 200m
          limits:
            memory: 1Gi
            cpu: "1"
        env:
          - name: AWS_PROFILE
            value: default
          - name: AWS_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_DEFAULT_REGION
            value: "{{workflow.parameters.aws_region}}"
          - name: AWS_SHARED_CREDENTIALS_FILE
            value: /workspace/.aws/credentials
          - name: AWS_CONFIG_FILE
            value: /workspace/.aws/config
    - name: notify-github
      container:
        image: curlimages/curl:8.4.0
        command:
          - sh
          - -c
        args:
          - |
            set -euo pipefail
            STATUS="{{workflow.status}}"
            case "$STATUS" in
              Succeeded) STATE=success ;;
              Skipped)   STATE=neutral ;;
              *)         STATE=failure ;;
            esac

            TOKEN=$(cat /github-token/token)
            TARGET_URL="http://localhost:2746/workflows/workflow-playground/{{workflow.name}}"

            post_status() {
              local owner="$1"
              local name="$2"
              if [ -z "$owner" ] || [ -z "$name" ]; then
                echo "Skipping status post because owner or name is empty"
                return 1
              fi

              local response http_code payload
              response=$(mktemp)
              payload=$(printf '{\n  "state": "%s",\n  "context": "argo/terraform",\n  "target_url": "%s",\n  "description": "Workflow %s finished with status %s"\n}\n' "$STATE" "$TARGET_URL" "{{workflow.name}}" "$STATUS")

              http_code=$(curl -sS -w "%{http_code}" -o "$response" \
                -X POST \
                -H "Authorization: Bearer $TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$owner/$name/statuses/{{workflow.parameters.commit_sha}}" \
                --data "$payload")

              if [ "$http_code" -ge 200 ] && [ "$http_code" -lt 300 ]; then
                echo "Posted GitHub status to $owner/$name (HTTP $http_code)"
                rm -f "$response"
                return 0
              fi

              echo "GitHub status update failed for $owner/$name (HTTP $http_code)" >&2
              cat "$response" >&2
              rm -f "$response"
              return 1
            }

            post_status "{{workflow.parameters.repo_owner}}" "{{workflow.parameters.repo_name}}" || \
              post_status "{{workflow.parameters.head_repo_owner}}" "{{workflow.parameters.head_repo_name}}"
        volumeMounts:
          - name: github-token
            mountPath: /github-token
            readOnly: true
